---
title: "Rescue Time"
subtitle: "An app to track your computer and mobile phone usage"
author:
    - Andrii Voitkiv
date: "`r format(Sys.time(), '%a, %b %d, %Y')`"
geometry: margin=2cm
output:
    html_document:
        toc: true
        toc_float: false
        toc_depth: 3
        number_sections: false
        fig_width: 12
        fig_height: 8
        fig_retina: 6
        fig_path: Figs/
        keep_md: false
        theme: united
        highlight: tango # pygments, kate, espresso, zenburn, haddock, textmate

---


```{r global_options, echo=FALSE}
# Set global options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results='asis')
```
```{r}
title_font_size <- 20
subtitle_font_size <- 14
font <- "Comfortaa"
```

_Creating your Story:_

_Structure your data story around a set of exactly 5 clear and explicit analysis questions._
_For each analysis question, describe the analysis process you used to try to answer it._
_Provide a concise discussion of your findings, supported by clear charts, statistics, and other analytic results. Include clear, well-captioned images that illustrate your analysis process, findings, and any problems you encountered. Annotating the images with captions, arrows, and notes can be very helpful._

```{r read_data, cache=TRUE}
# Read data
RT_mobile <- read.csv("/Users/berg/DataspellProjects/MDSA-UofC/DATA605/10_project/data/rescuetime-minute-grouped-mobile.csv")
RT_pc <- read.csv("/Users/berg/DataspellProjects/MDSA-UofC/DATA605/10_project/data/rescuetime-minute-grouped-pc.csv")
```

```{r}
# Productivity colors from Rescue Time app:----
Productivity_col <- rgb(red = c(13, 65, 177, 218, 212, 160),
                        green = c(88, 130, 193, 105, 28, 235),
                        blue = c(193, 221, 191, 93, 21, 142),
                        names = c("Very Productive", "Productive", "Neutral",
                                  "Distracting", "Very Distracting", "Mobile Phone"),
                        maxColorValue = 255)
colors <- Productivity_col[c("Productive", "Very Distracting")]
```

```{r}
# Use the ggridges package to create a density plot. On x-axis we have the 'hm' variable, which is the hour and minute of the day. On the y-axis use day names. Plot both mobile and pc Duration.
RT_mobile$weekday <- factor(RT_mobile$weekday, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
RT_pc$weekday <- factor(RT_pc$weekday, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
```

```{r}
# Combine the two data frames into one data frame with a Device column that I lost during the grouping process
RT_mobile$Device <- "Mobile"
RT_pc$Device <- "PC"
RT_mobile_pc <- rbind(RT_mobile, RT_pc)
# Make `Device` a factor
RT_mobile_pc$Device <- factor(RT_mobile_pc$Device, levels = c("PC", "Mobile"))
```

```{r}
library(dplyr)
# Group by Device, weekday and hm. Summarize Duration with mean
RT_mobile_pc <- RT_mobile_pc %>%
  group_by(Device, weekday, hm) %>%
  summarize(Duration = mean(Duration)) %>%
  mutate(row = row_number() - 1)
```
```{r}
# Create a vector of breaks for the x-axis
starttime <- 6
time_interval <- 5
breaks <- seq(0, (24 - starttime) * (60 / time_interval) - 1, by = 60 / time_interval)

# Filter data by `row` more than 72 (6 am) = 6 * 12 = 72
RT_mobile_pc <- RT_mobile_pc %>%
  filter(row > starttime * (60 / time_interval) - 1)

# Update row variable to start from 0
RT_mobile_pc$row <- RT_mobile_pc$row - starttime * (60 / time_interval)
```




```{r}
# Make a ggridges plot using the ggridges package
library(ggridges)
library(ggplot2)
library(ggtext)

RT_mobile_pc_averages <- RT_mobile_pc %>%
  group_by(weekday, Device) %>%
  summarize(average = round(mean(Duration))) %>%
  mutate(average_hours = floor(average / 60),
         average_minutes = average %% 60,
         average_formatted = paste0(average_hours, "h ", average_minutes)) %>%
  arrange(Device)


# Create a title and subtitle
title <- paste0("Time spent on <span style = 'color: ",
                colors[1], ";'>", levels(RT_mobile_pc$Device)[1],
                "</span> vs. <span style = 'color: ",
                colors[2], ";'>", levels(RT_mobile_pc$Device)[2], "</span>")
subtitle <- paste0("Meausred in minutes by Rescue Time app")

# make the plot:
ggplot(data = RT_mobile_pc, aes(x = row, y = weekday)) +
  geom_density_ridges(aes(fill = Device, color = Device,  height = Duration),
                      stat="identity", alpha = 0.75, size = 0.2, scale = 0.9, show.legend = FALSE) +
  geom_text(data = RT_mobile_pc_averages, aes(x= (24 - starttime) * (12 + 1/4), y = c(1:7 + 0.5, 1:7 + 0.2),
                               label = paste(average_formatted,  "/day"),
                               hjust = 0, vjust = 0, family = font, color = Device),
            show.legend = FALSE, size = 3.5) +
  labs(x = "Time of Day", y = NULL, title = title, subtitle = subtitle) +
  coord_cartesian(clip = "off") +
  theme_minimal(base_family = font) +
  theme(plot.margin = unit(c(2, 22, 2, 2), "mm"),
        plot.background = element_rect(fill='transparent', color=NA),
        panel.grid = element_blank(),
        plot.title.position = "plot",
        plot.title = element_markdown(face = "bold", size = title_font_size, hjust = 0, color = "grey10"),
        plot.subtitle = element_markdown(size = subtitle_font_size, hjust = 0, color = "grey20", margin = margin(b = 20)),
        axis.title.x = element_text(face = "bold", margin = margin(t = 6), color = "grey40", size = 10),
        axis.text.x = element_text(size = 8, color = "grey50", margin = margin(t = 5)),
        axis.text.y = element_text(size = 10, color = "grey30", margin = margin(r = 5), vjust = 0),
        axis.ticks.x = element_line(color = "grey60", linewidth = 0.2)) +
  scale_x_continuous(expand = c(0, 0), breaks = breaks, labels = RT_mobile_pc$hm[breaks + 1]) +
  scale_y_discrete(expand = c(0,0)) +
  scale_fill_manual(values = hsv(h = rgb2hsv(col2rgb(colors))[1,],
                                 s = rgb2hsv(col2rgb(colors))[2,],
                                 v = rgb2hsv(col2rgb(colors))[3,])) +
  scale_color_manual(values = hsv(h = rgb2hsv(col2rgb(colors))[1,],
                                  s = rgb2hsv(col2rgb(colors))[2,],
                                  v = rgb2hsv(col2rgb(colors))[3,] - 0.1))

```

## Productivity per day of the week and time of day {.tabset}
### Productivity per day of the week {.tabset}
```{r, cache=TRUE}
# Read data
RT_hourly <- read.csv("/Users/berg/DataspellProjects/MDSA-UofC/DATA605/10_project/data/rescuetime_hourly_20018-2022.csv")
```

```{r}
RT_by_weekday <- RT_hourly %>%
  group_by(weekday, Productivity) %>%
  summarize(Duration = sum(Duration)) %>%
  mutate(Productivity = case_when(
           Productivity == 2 ~ "Very Productive",
           Productivity == 1 ~ "Productive",
           Productivity == 0 ~ "Neutral",
           Productivity == -1 ~ "Distracting",
           Productivity == -2 ~ "Very Distracting"
  )
  )

RT_by_weekday_count <- RT_hourly %>%
  group_by(weekday) %>%
  summarize(count = n_distinct(as.Date(paste(year, month, dom, sep = "-"), format = "%Y-%m-%d")))

RT_by_weekday_merged <- left_join(RT_by_weekday, RT_by_weekday_count, by = "weekday")

RT_by_weekday_merged <- RT_by_weekday_merged %>%
  mutate(weekday = factor(weekday, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
         Avg_Duration = Duration / count / 3600,
         Avg_Duration = if_else(Productivity %in% c("Distracting", "Very Distracting"), -Avg_Duration, Avg_Duration))

```

```{r}
library('tidyverse')
# Create a title and subtitle
label <- sub(",([^,]*)$", " and\\1", paste0("<span style='font-size:8pt;'>",
                                            paste(imap_chr(Productivity_col[-c(4:6)], function(color, name){
                                              paste0("<span style='color:", color, ";'>", name, "</span>")
                                            }), collapse = ", "), " time are shown as positive values. <br>",
                                            paste(imap_chr(Productivity_col[c(5,4)], function(color, name){
                                              paste0("<span style='color:", color, ";'>", name, "</span>")
                                            }), collapse = " and "), " time are shown as negative values. </span>"))

title <- paste0("Productivity by Day of the Week")
subtitle <- paste0("Meausred in minutes by Rescue Time app")

# Make the plot
ggplot(data = RT_by_weekday_merged, aes(x = weekday, y = Avg_Duration, fill = Productivity)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(x = "Day of the Week", y = "Time Spent (hours)", title = title, subtitle = paste0("Measured with RescueTime <br>
                         <br>", label)) +
  theme_minimal(base_family = "Comfortaa") +
  scale_fill_manual(values = Productivity_col) +
  coord_cartesian(clip = "off") +
  theme(plot.margin = unit(c(2, 2, 2, 2), "mm"),
        panel.grid.major.y = element_line(color = "grey90", size = 0.2),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "none",
        plot.title.position = "plot",
        plot.title = element_markdown(face = "bold", size = title_font_size, hjust = 0, color="grey10"),
        plot.subtitle = element_markdown(size = subtitle_font_size, hjust = 0, color="grey20"),
        axis.text.y = element_text(size=10, color = "grey30"),
        axis.title.x = element_text(face = "bold", margin = margin(t = 6), color = "grey40", size = 10),
        axis.ticks.x = element_line(color = "grey60", size = 0.1),
        axis.title.y = element_text(face = "bold", color = "grey40", size = 10),
        axis.text.x = element_text(size = 10, color = "grey50", margin = margin(t = 2)))

```

### Productivity per time of day {.tabset}
```{r}
start_date <- as.Date("2018-01-01")
end_date <- as.Date("2022-12-31")
unique_hours <- as.numeric(difftime(end_date, start_date, units = "hours")) / 24


RT_by_hour <- RT_hourly %>%
  group_by(hour, Productivity) %>%
  summarize(Duration = sum(Duration)) %>%
  mutate(Productivity = case_when(
    Productivity == 2 ~ "Very Productive",
    Productivity == 1 ~ "Productive",
    Productivity == 0 ~ "Neutral",
    Productivity == -1 ~ "Distracting",
    Productivity == -2 ~ "Very Distracting"),
         Avg_Duration = Duration / unique_hours / 60,
         Avg_Duration = if_else(Productivity %in% c("Distracting", "Very Distracting"), -Avg_Duration, Avg_Duration))

```


```{r}
# # TODO: Check how I calculate the unique hours
# # Create a title and subtitle
# label <- sub(",([^,]*)$", " and\\1", paste0("<span style='font-size:8pt;'>",
#                                             paste(imap_chr(Productivity_col[-c(4:6)], function(color, name){
#                                               paste0("<span style='color:", color, ";'>", name, "</span>")
#                                             }), collapse = ", "), " time are shown as positive values. <br>",
#                                             paste(imap_chr(Productivity_col[c(5,4)], function(color, name){
#                                               paste0("<span style='color:", color, ";'>", name, "</span>")
#                                             }), collapse = " and "), " time are shown as negative values. </span>"))
# title <- paste0("Productivity by Hour of the Day")
# subtitle <- paste0("Meausred in minutes by Rescue Time app")
#
# # Make the plot
# p <- ggplot(data = RT_by_hour, aes(x = hour, y = Avg_Duration, fill = Productivity)) +
#   geom_bar(stat = "identity", position = "stack") +
#   labs(x = "Hour of the Day", y = "Time Spent (minutes)", title = title, subtitle = paste0("Measured with RescueTime <br>
#                          <br>", label)) +
#   theme_minimal(base_family = "Comfortaa") +
#   scale_fill_manual(values = Productivity_col) +
#   coord_cartesian(clip = "off") +
#   theme(plot.margin = unit(c(2, 2, 2, 2), "mm"),
#         panel.grid.major.y = element_line(color = "grey90", size = 0.2),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.major.x = element_blank(),
#         legend.position = "none",
#         plot.title.position = "plot",
#         plot.title = element_markdown(face = "bold", size = title_font_size, hjust = 0, color="grey10"),
#         plot.subtitle = element_markdown(size = subtitle_font_size, hjust = 0, color="grey20"),
#         axis.text.y = element_text(size=10, color = "grey30"),
#         axis.title.x = element_text(face = "bold", margin = margin(t = 6), color = "grey40", size = 10),
#         axis.ticks.x = element_line(color = "grey60", size = 0.1),
#         axis.title.y = element_text(face = "bold", color = "grey40", size = 10),
#         axis.text.x = element_text(size = 10, color = "grey50", margin = margin(t = 2))) +
#   scale_x_continuous(breaks= 0:23 - 0.5, labels = paste0(0:23, ":00"), expand = c(0.01, 0.01))

# # Make the animation
# library(gganimate)
# library(gifski)
# animation <- p + transition_states(hour, transition_length = 2, state_length = 1, wrap = FALSE) + shadow_mark() #+ enter_fade() + exit_shrink()
# anim_save("/Users/berg/DataspellProjects/MDSA-UofC/DATA605/10_project/animation.gif", animation, width = 1200, height = 800, renderer = gifski_renderer())
```
<img src="/Users/berg/DataspellProjects/MDSA-UofC/DATA605/10_project/animation.gif"/>

## Review




